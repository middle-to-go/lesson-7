---
customTheme : "presentation"

---

## –õ–µ–∫—Ü–∏—è 7. –†–∞–±–æ—Ç–∞ —Å –ë–î –≤ Go
### OZON

### –ú–æ—Å–∫–≤–∞, 2021


---

### –õ–µ–∫—Ü–∏–∏

1. <span style="color:gray">–í–≤–µ–¥–µ–Ω–∏–µ. –†–∞–±–æ—á–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π.</span>
2. <span style="color:gray">–ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö.</span>
3. <span style="color:gray">–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –æ—Å–Ω–æ–≤—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
4. <span style="color:gray">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –º–æ–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–∏–º–∏</span>
5. <span style="color:gray">–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ Go</span>
6. <span style="color:gray">Protobuf –∏ gRPC</span>
7. –†–∞–±–æ—Ç–∞ —Å –ë–î –≤ Go
8. <span style="color:gray">–ë—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π. –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞. –ú–µ—Ç—Ä–∏–∫–∏. </span>

---

### –¢–µ–º—ã

–°–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –ø—Ä–æ:

1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL
1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –°–£–ë–î –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π <!-- .element: class="fragment" -->
1. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ <!-- .element: class="fragment" -->
1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã sql.DB, sql.Rows, sql.Tx <!-- .element: class="fragment" -->
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π <!-- .element: class="fragment" -->
1. SQL –∏–Ω—ä–µ–∫—Ü–∏–∏ –∏ –±–æ—Ä—å–±–∞ —Å –Ω–∏–º–∏ <!-- .element: class="fragment" -->
1. –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î <!-- .element: class="fragment" -->
1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ë–î –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å <!-- .element: class="fragment" -->
1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ <!-- .element: class="fragment" -->

---

### –û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è

* üìΩÔ∏è - –ø–æ—Å–º–æ—Ç—Ä–∏ –≤–æ—Ä–∫—à–æ—É
* ‚öóÔ∏è - –ø—Ä–æ–≤–µ–¥–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
* üî¨ - –∏–∑—É—á–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ
* üìñ - –ø—Ä–æ—á–∏—Ç–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
* ü™ô - –ø–æ–¥—É–º–∞–π –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
* üêû - –∑–∞–ø–æ–º–Ω–∏ –æ—à–∏–±–∫—É
* üî® - –∑–∞–ø–æ–º–Ω–∏ —Ä–µ—à–µ–Ω–∏–µ
* üèîÔ∏è - –æ–±–æ–π–¥–∏ –∫–∞–º–µ–Ω—å –ø—Ä–µ–¥–∫–Ω–æ–≤–µ–Ω—å—è
* ‚è∞ - —Å–¥–µ–ª–∞–π –ø–µ—Ä–µ—Ä—ã–≤
* üè° - –ø–æ–ø—Ä–æ–±—É–π –¥–æ–º–∞
* üí° - –æ–±—Å—É–¥–∏ —Å–≤–µ—Ç–ª—ã–µ –∏–¥–µ–∏
* üôã - –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å
* ‚ö° - –∑–∞–ø–æ–º–Ω–∏ –ø–∞–Ω–∏–∫—É

---

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –ª–æ–∫–∞–ª—å–Ω–æ

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ (–ø—Ä–∏–º–µ—Ä –¥–ª—è Ubuntu):

```bash
# –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã
$ sudo apt-get update
# —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL —Å–µ—Ä–≤–µ—Ä –∏ –∫–ª–∏–µ–Ω—Ç
$ sudo apt-get -y install postgresql
# –∑–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL
$ sudo systemctl start postgresql
# –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
$ sudo -u postgres psql
```

https://www.postgresql.org/download/linux/ubuntu/

---

### –†–∞–±–æ—Ç–∞–µ–º —Å PostgreSQL –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Docker

–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–µ—Ä–≤–µ—Ä–æ–º PostgreSQL:

```bash
  docker run -d \
  --name pg \
  -e POSTGRES_PASSWORD=postgres \
  -e PGDATA=/var/lib/postgresql/data/pgdata \
  -v /Users/sivliev/psqldata:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres
 ```

–ñ–¥—ë–º –Ω–µ–º–Ω–æ–≥–æ, –ø–æ–∫–∞ –°–£–ë–î –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è
–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É:
```bash
docker exec -it pg psql -Upostgres -dpostgres
```

https://hub.docker.com/_/postgres


---

### –†–∞–±–æ—Ç–∞–µ–º —Å PostgreSQL –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Docker

–ú–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –≤ docker-compose:

```yaml
version: '3.1'

services:

  db:
    image: postgres
    restart: always
    volumes:
      - /Users/sivliev/psqldata:/var/lib/postgresql/data 
    environment:
      POSTGRES_PASSWORD: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - 5432:5432
  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
```

```bash
docker-compose up
```
 
N.b.: –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö Docker `docker-compose` —Å—Ç–∞–ª —á–∞—Å—Ç—å—é –∫–æ–º–∞–Ω–¥—ã `docker` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ `docker compose`.


---

### –°–æ–∑–¥–∞–Ω–∏–µ –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
postgres=# create database lecture_7_demo;
postgres=# create user sirius with encrypted password 'lecture_7_demo';
postgres=# grant all privileges on database lecture_7_demo to sirius;
```

---

### –ú–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Goose

https://github.com/pressly/goose

Goose ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è. 

–ò–¥–µ—è –ø—Ä–æ—Å—Ç–∞:
* –í—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ —Ñ–∞–π–ª—ã —Å—Ö–µ–º—ã SQL, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–µ–¥—É—é—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É —Å–æ–≥–ª–∞—à–µ–Ω–∏—é –æ–± –∏–º–µ–Ω–∞—Ö
* –í—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ–π `dbconf.yml` —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç Goose, –∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≤–∞—à–∏–º —Ä–∞–∑–ª–∏—á–Ω—ã–º –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö
* Goose –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∞–º –ø—Ä–æ—Å—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã (`goose up`), –ø—Ä–æ–≤–µ—Ä–∫–∏ (`goose status`) –∏ –¥–∞–∂–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ (`goose down`).


---

### –ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏

```sql

-- +goose Up
CREATE table books (
  id serial primary key,
  title text,
  description text,
  meta jsonb,
  created_at timestamptz not null default now(),
  updated_at timestamptz
);

INSERT INTO books (title, description, meta, updated_at)
VALUES
  ('–ú–∞—Å—Ç–µ—Ä –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', 'test description 1', '{}', now()),
  ('–ì—Ä–∞—Ñ –ú–æ–Ω—Ç–µ-–ö—Ä–∏—Å—Ç–æ', 'test description 2', null, null),
  ('–ú–∞—Ä—Å–∏–∞–Ω–∏–Ω', 'test description 3', '{"author": "–≠–Ω–¥–∏ –í–µ–π–µ—Ä"}', now());

-- +goose Down
drop table books;
```

---

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –∏–∑ Go, –ø—Ä–æ—Å—Ç–µ–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç


–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```go
import "database/sql"
import _ "github.com/jackc/pgx/stdlib"

dsn := "..."
db, err := sql.Open("pgx", dsn) // *sql.DB
if err != nil {
 log.Fatalf("failed to load driver: %v", err)
}
// —Å–æ–∑–¥–∞–Ω –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```go
err := db.PingContext(ctx)
if err != nil {
 return xerrors.Errorf("failed to connect to db: %v", err)
}
// —Ä–∞–±–æ—Ç–∞–µ–º —Å db
```

http://go-database-sql.org/importing.html

http://go-database-sql.org/accessing.html


---

### DataSourceName

DSN - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ, —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø—Ü–∏–∏.
–°–∏–Ω—Ç–∞–∫—Å–∏—Å DSN –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –¥—Ä–∞–π–≤–µ—Ä–∞.

–ù–∞–ø—Ä–∏–º–µ—Ä –¥–ª—è PostgreSQL:

```
"postgres://myuser:mypass@localhost:5432/mydb?sslmode=verify-full"
```

–∏–ª–∏

```
"user=myuser dbname=mydb sslmode=verify-full password=mypass"
```

---

### DataSourceName

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: 
* `host` - –°–µ—Ä–≤–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø—É—Ç—å –∫ UNIX-—Å–æ–∫–µ—Ç—É (–ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é `localhost`)
* `port` - –ü–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é `5432`)
* `dbname` - –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
* `user` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –°–£–ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å OS)
* `password` - –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: https://godoc.org/github.com/lib/pq

---

### –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

üôã –ê –∑–∞—á–µ–º –Ω–∞–º –≤–æ–æ–±—â–µ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π?

`sql.DB` - —ç—Ç–æ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

`sql.DB` - –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Ç–∞–∫ –∂–µ –∫–∞–∫ `http.Client`)

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞:

```go
// –ú–∞–∫—Å. —á–∏—Å–ª–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –æ—Ç —ç—Ç–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
db.SetMaxOpenConns(n int)
// –ú–∞–∫—Å. —á–∏—Å–ª–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
db.SetMaxIdleConns(n int)
// –ú–∞–∫—Å. –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
db.SetConnMaxLifetime(d time.Duration)
```

http://go-database-sql.org/connection-pool.html

---

### –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

<img src="images/connection_pool.png"></img>

---

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

```go
query := `insert into events(owner, title, descr, start_date, end_date)
 values($1, $2, $3, $4, $5)`
result, err := db.ExecContext(ctx, query,
 42, "new year", "watch the irony of fate", "2019-12-31", "2019-12-31"
) // sql.Result
if err != nil {
 // –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É
}
// –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π ID (SERIAL)
eventId, err := result.LastInsertId() // int64
// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
rowsAffected, err := result.RowsAffected() // int64
```
http://go-database-sql.org/retrieving.html

---

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```go
query := `
 select id, title, descr
 from events
 where owner = $1 and start_date = $2
`
rows, err := db.QueryContext(ctx, query, owner, date)
if err != nil {
  // –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
}
defer rows.Close()
for rows.Next() {
  var id int64
  var title, descr string
  if err := rows.Scan(&id, &title, &descr); err != nil {
  // –æ—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  }
  // –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É
  fmt.Printf("%d %s %s\n", id, title, descr)
}
if err := rows.Err(); err != nil {
  // –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
}
```

---

### –û–±—ä–µ–∫—Ç sql.Rows

```go
// –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –≤ –≤—ã–±–æ—Ä–∫–µ
rows.Columns() ([]string, error)
// –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫ –≤ –≤—ã–±–æ—Ä–∫–µ
rows.ColumnTypes() ([]*ColumnType, error)
// –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false
rows.Next() bool
// –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
rows.Scan(dest ...interface{}) error
// –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç Rows
rows.Close()
// –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, –≤—Å—Ç—Ä–µ—á–µ–Ω–Ω—É—é –ø—Ä–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
rows.Err() error
```

---

### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

```go
query := "select * from events where id = $1"
row := db.QueryRowContext(ctx, query, id)
var id int64
var title, descr string
err := row.Scan(&id, &title, &descr)
if err == sql.ErrNoRows {
  // —Å—Ç—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
} else if err != nil {
  // "–Ω–∞—Å—Ç–æ—è—â–∞—è" –æ—à–∏–±–∫–∞
}
```

---

### PreparedStatements

PreparedStatement - —ç—Ç–æ –∑–∞—Ä–∞–Ω–µ–µ —Ä–∞–∑–æ–±—Ä–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ.

PreparedStatement - –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –°–£–ë–î –∏ –∂–∏–≤–µ—Ç –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏, –∏–ª–∏ –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç.

```go

// —Å–æ–∑–¥–∞–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
stmt, err := db.Prepare("delete from events where id = $1") // *sql.Stmt
if err != nil {
 log.Fatal(err)
}
// –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –≤ –°–£–ë–î
defer stmt.Close()
// –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
  for _, id := range ids {
  _, err := stmt.Exec(id)
  if err != nil {
    log.Fatal(err)
  }
}

```

http://go-database-sql.org/prepared.html

---

### –†–∞–±–æ—Ç–∞ —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º

`*sql.DB` - —ç—Ç–æ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π. –î–∞–∂–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ–¥–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —Ç–æ

```go
conn, err := db.Conn(ctx) // *sql.Conn
// –≤–µ—Ä–Ω—É—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ pool
defer conn.Close()
// –¥–∞–ª–µ–µ - –æ–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–∞–∫ —Å *sql.DB
err := conn.ExecContext(ctx, query1, arg1, arg2)
rows, err := conn.QueryContext(ctx, query2, arg1, arg2)
```

---

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è - –≥—Ä—É–ø–ø–∞ –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, –ª–∏–±–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–º–µ—Å—Ç–µ. –í–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–∏–¥—è—Ç "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ" —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

–ù–∞ —É—Ä–æ–≤–Ω–µ SQL –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: `BEGIN`, `COMMIT`,`ROLLBACK`.

```go
tx, err := db.BeginTx(ctx, nil) // *sql.Tx
if err != nil {
  log.Fatal(err)
}
// –¥–∞–ª–µ–µ - –æ–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–∞–∫ —Å *sql.DB
err := tx.ExecContext(ctx, query1, arg1, arg2)
rows, err := tx.QueryContext(ctx, query2, arg1, arg2)
err := tx.Commit() // –∏–ª–∏ tx.Rollback()
if err != nil {
  // commit –Ω–µ –ø—Ä–æ—à–µ–ª, –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
}
  // –¥–∞–ª–µ–µ –æ–±—ä–µ–∫—Ç tx –Ω–µ –ø—Ä–∏–≥–æ–¥–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

http://go-database-sql.org/modifying.html

---

### –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

```go

// WithTxFunc custom type of func to helper
type WithTxFunc func(ctx context.Context, tx sqlutil.Tx) error

// WithTx runs code with transaction
func (d *tx) WithTx(ctx context.Context, fn WithTxFunc) error {
  t, err := d.db.Begin(ctx, nil)
  if err != nil {
    return errors.Wrap(err, "Tx.Begin")
  }
  if err = fn(ctx, t); err != nil {
    if errRollback := t.Rollback(); errRollback != nil {
      return errors.Wrap(err, "Tx.Rollback")
    }
    return errors.Wrap(err, "Tx.WithTxFunc")
  }
  if err = t.Commit(); err != nil {
    return errors.Wrap(err, "Tx.Commit")
  }
  return nil
}
```


---

### –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —É `*sql.DB`, `*sql.Conn`, `*sql.Tx`, `*sql.Stmt`:

```go
// –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
ExecContext(ctx context.Context, query string, args ...interface{}) (Result, error)
// –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (select)
QueryContext(ctx context.Context, query string, args ...interface{}) (*Rows, error)
// –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
QueryRowContext(ctx context.Context, query string, args ...interface{}) *Row
```

üêû –í–Ω–∏–º–∞–Ω–∏–µ, –æ—à–∏–±–∫–∞:
```go
_, err := db.QueryContext(ctx, "delete from events where id = $1", 42)
```

---

### NULL


–í SQL –±–∞–∑–∞—Ö –ª—é–±–∞—è –∫–æ–ª–æ–Ω–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∞ –∫ NULL / NOT NULL. NULL - —ç—Ç–æ –Ω–µ 0 –∏ –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, —ç—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è.

```sql
create table users (
  id serial primary key,
  name text not null,
  age int null
);
```

–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ `NULL` –≤ Go –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:

```go
var id, realAge int64
var name string
var age sql.NullInt64
err := db.QueryRowContext(ctx, "select * from users where id = 1").Scan(&id, &name, &age)

if age.Valid {
  realAge = age.Int64
} else {
  // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –≤–∞—à–µ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ
}
```

---

### SQL Injection

<img src="images/exploits_of_a_mom.png">

---

### SQL Injection

–û–ø–∞—Å–Ω–æ:
```go
query := "select * from users where name = '" + name + "'"
query := fmt.Sprintf("select * from users where name = '%s'", name)
```

–ü–æ—Ç–æ–º—É —á—Ç–æ –≤ name –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞:
```
"jack'; truncate users; select 'pawned"
```


---

### SQL Injection

–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å placeholders –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π –≤ SQL:
```go
row := db.QueryRowContext(ctx, "select * from users where name = $1", name)
```

–û–¥–Ω–∞–∫–æ —ç—Ç–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–º–æ–∂–Ω–æ. –¢–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç:
```go
db.QueryRowContext(ctx, "select * from $1 where name = $2", table, name)
db.QueryRowContext(ctx, "select * from user order by $1 limit 3", order)
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –Ω–∞ –∏–Ω—ä–µ–∫—Ü–∏–∏ (–∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏): https://github.com/securego/gosec

---

### Squirrel - fluent SQL generator for Go

```go
sql, args, err := sq.
 Insert("users").Columns("name", "age").
 Values("moe", 13).Values("larry", sq.Expr("? + 5", 12)).
 ToSql()
```

```
sql == "INSERT INTO users (name,age) VALUES (?,?),(?,? + 5)"
```

---

### Squirrel - fluent SQL generator for Go

```go

query := sq.Insert(tableName).
  Columns("description").
  Values(task.Description).
  Suffix("RETURNING \"id\"").
  RunWith(r.db).
  PlaceholderFormat(sq.Dollar)
‚Äã
query.QueryRowContext(ctx).Scan(&task.Id)
```

```go
  query := sq.Update(tableName).
    SetMap(map[string]interface{}{
      "id": task.Description,
    }).
    Where(sq.Eq{"id": task.Id}).
    RunWith(r.db).
    PlaceholderFormat(sq.Dollar)
‚Äã
  _, err := query.ExecContext(ctx)
  return err
```


---

### –ü—Ä–æ–±–ª–µ–º—ã database/sql

* placeholder –∑–∞–≤–∏—Å—è—Ç –æ—Ç –±–∞–∑—ã: ( `$1` –≤ Postgres, `?` –≤ MySQL, `:name` –≤ Oracle)
* –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã, –Ω–æ –Ω–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä `sql.NullDate`
* `rows.Scan(arg1, arg2, arg3)` - –Ω–µ—É–¥–æ–±–µ–Ω, –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏ —Ç–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫.
* –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ `rows.StructScan(&event)`

---

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ sqlx

`jmoiron/sqlx` - –æ–±–µ—Ä—Ç–∫–∞, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ —Ä–∞—Å—à–∏—Ä—è—é—â–∞—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `database/sql`:
* `sqlx.DB` - –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ `*sql.DB`
* `sqlx.Tx` - –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ `*sql.Tx`
* `sqlx.Stmt` - –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ `*sql.Stmt`
* `sqlx.NamedStmt` - PreparedStatement —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–º–µ–Ω–æ–≤–∞–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ sqlx

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ `jmoiron/sqlx`:

```go
import "github.com/jmoiron/sqlx"


db, err := sqlx.Open("pgx", dsn) // *sqlx.DB
rows, err := db.QueryContext("select * from events") // *sqlx.Rows
...
```

---

### sqlx: –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ placeholder'—ã

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è:

```go
sql := "select * from events where owner = :owner and start_date = :start"
rows, err := db.NamedQueryContext(ctx, sql, map[string]interface{}{
  "owner": 42,
  "start": "2019-12-31",
})
```
–ò–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```go
type QueryArgs{
 Owner int64
 Start string
}

sql := "select * from events where owner = :owner and start_date = :start"

rows, err := db.NamedQueryContext(ctx, sql, QueryArgs{
 Owner: 42,
 Start: "2019-12-31",
})
```

---

### sqlx: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

–ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Å–ª–æ–≤–∞—Ä—å:


```go

sql := "select * from events where start_date > $1"
rows, err := db.QueryContext(ctx, sql, "2020-01-01") // *sqlx.Rows
for rows.Next() {
 results := make(map[string]interface{})
 err := rows.MapScan(results)
 if err != nil {
  log.Fatal(err)
 }
 // –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º result
}
```

---

### sqlx: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

–ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```go
type Event {
  Id int64
  Title string
  Description string `db:"descr"`
}
sql := "select * from events where start_date > $1"
rows, err := db.NamedQueryContext(ctx, sql, "2020-01-01") // *sqlx.Rows
events := make([]Event)
for rows.Next() {
    var event Event
    err := rows.StructScan(&event)
    if err != nil {
    log.Fatal(err)
  }
  events = append(events, event)
}
```

---

### –î—Ä–∞–π–≤–µ—Ä—ã –¥–ª—è Postgres

* –õ—É—á—à–∏–π –¥—Ä–∞–π–≤–µ—Ä –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç: https://github.com/jackc/pgx
* –î—Ä—É–≥–æ–π —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥—Ä–∞–π–≤–µ—Ä (–º–µ–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π): https://github.com/lib/pq

---

### ORM

* https://gorm.io/ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—É—Å—Ç—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã :(
* https://github.com/go-reform/reform - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–º–Ω–æ–≥–æ –∑–∞–±—Ä–æ—à–µ–Ω–∞

---

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

https://github.com/DATA-DOG/go-txdb -- Single transaction based sql.Driver for GO


```go
func init() {
  txdb.Register("txdb", "mysql", "root@/txdb_test")
}

func main() {
  db, err := sql.Open("txdb", "identifier")
  if err != nil {
    log.Fatal(err)
  }
  defer db.Close()
  if _, err := db.Exec(`INSERT INTO users(username) VALUES("gopher")`); err != nil {
    log.Fatal(err)
    }
 }
 ```

---

### –ú–æ–∫–∏

https://github.com/DATA-DOG/go-sqlmock

```go

func TestShouldUpdateStats(t *testing.T) {
  db, mock, err := sqlmock.New()
  if err != nil {
    t.Fatalf("an error '%s' was not expected when opening a stub database connection", err)
  }
  defer db.Close()
  mock.ExpectBegin()
  mock.ExpectExec("INSERT INTO product_viewers").WithArgs(2, 3)).WillReturnResult(sqlmock.NewResult(1, 1))
  mock.ExpectCommit()
  if err = recordStats(db, 2, 3); err != nil {
    t.Errorf("error was not expected while updating stats: %s", err)
  }
  if err := mock.ExpectationsWereMet(); err != nil {
    t.Errorf("there were unfulfilled expectations: %s", err)
  }
}
```

---

### –§–∏–∫—Å—Ç—É—Ä—ã

https://github.com/go-testfixtures/testfixtures

```yaml
# comments.yml
- id: 1
 post_id: 1
 content: A comment...
 author_name: John Doe
 author_email: john@doe.com
 created_at: 2020-12-31 23:59:59
 updated_at: 2020-12-31 23:59:59
- id: 2
 post_id: 2
 content: Another comment...
 author_name: John Doe
 author_email: john@doe.com
 created_at: 2020-12-31 23:59:59
 updated_at: 2020-12-31 23:59:59
# ...
```

---

### –§–∏–∫—Å—Ç—É—Ä—ã

```go
fixtures, err := testfixtures.New(
  testfixtures.Database(db),
  testfixtures.Dialect("postgres"),
  testfixtures.Paths(
    "fixtures/orders.yml",
    "fixtures/customers.yml",
    "common_fixtures/users"
  ),
)
if err != nil {
 ...
}
```

---

### –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î

–•–æ—Ä–æ—à–∏–π –¥–æ–∫–ª–∞–¥, –Ω–æ –±–æ–ª—å—à–µ –ø—Ä–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≤–µ—â–∏: https://www.youtube.com/watch?v=HjLnY0aPQZo

–ë–æ–ª—å—à–æ–π —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫: https://stackoverflow.com/questions/621884/database-development-mistakes-made-by-application-developers

–ü–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∞—à –∑–∞–ø—Ä–æ—Å –ø–æ–º–æ–∂–µ—Ç ```EXPLAIN ANALYZE <–≤–∞—à –∑–∞–ø—Ä–æ—Å>```. 

–°–ª–µ–¥–∏—Ç–µ, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã.

---

### –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î

–û—Ç –º–µ–Ω—è:

1. LIMIT –∏ OFFSET 
2. IN –ø–æ –±–æ–ª—å—à–æ–º—É —Å–ø–∏—Å–∫—É
3. –•—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Å–æ–∑–¥–∞—é—â–∏–µ –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ —Å–≤—è–∑–∏ –≤ –¥–∞–Ω–Ω—ã—Ö
4. GIN –∏–Ω–¥–µ–∫—Å –Ω–∞–¥ JSON –ø–æ–ª–µ–º
5. –î—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
6. –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –≥–æ—Ä—è—á–∏–µ (UPDATE) –∏ —Ö–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (APPEND-ONLY)
7. SELECT FOR UPDATE

---

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ë–î –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

–ù–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è, —á—Ç–æ–±—ã —É –Ω–∞—Å –±—ã–ª –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Ä–≤–∏—Å–∞.

–ú—ã –º–æ–∂–µ–º —Å–≤—è–∑–∞—Ç—å –ë–î —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.

```go

package db

import (
	"context"
	"log"

	_ "github.com/jackc/pgx/v4"
	_ "github.com/jackc/pgx/v4/stdlib"
	"google.golang.org/grpc"

	"database/sql"
)

var dbKey = "db"

// GetDBKey ...
func GetDBKey() string {
	return dbKey
}

// Connect ...
func Connect(DSN string) *sql.DB {
	db, err := sql.Open("pgx", DSN)
	if err != nil {
		log.Fatalf("connect do db error %v", err)
	}
	return db

}

```

---

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ë–î –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

```go
// NewContext ...
func NewContext(ctx context.Context, db *sql.DB) context.Context {
	ctxDB := context.WithValue(ctx, &dbKey, db)

	return ctxDB
}

// FromContext ...
func FromContext(ctx context.Context) *sql.DB {
	client, ok := ctx.Value(&dbKey).(*sql.DB)
	if !ok {
		panic("Error getting connection from context")
	}
	return client
}

// GetDB ...
func GetDB(ctx context.Context) *sql.DB {
	return FromContext(ctx)
}

// NewInterceptorWithDB ...
func NewInterceptorWithDB(db *sql.DB) grpc.UnaryServerInterceptor {
	return func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, 
  handler grpc.UnaryHandler) (resp interface{}, err error) {
		return handler(NewContext(ctx, db), req)
	}
}
```

---

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ë–î –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

–î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä.

```go
func run(dbConn *sql.DB) error {
	listen, err := net.Listen("tcp", grpcPort)
	if err != nil {
		log.Fatalf("failed to listen: %v", err)
	}

	s := grpc.NewServer(grpc.ChainUnaryInterceptor(db.NewInterceptorWithDB(dbConn)))
	desc.RegisterLecture6DemoServer(s, api.NewLecture6DemoAPI())



	if err := s.Serve(listen); err != nil {
		log.Fatalf("failed to serve: %v", err)
	}

	return nil
}
```

---

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ë–î –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

```go
func (a *Lecture6DemoAPI)AddV1(ctx context.Context,
	req *desc.AddRequestV1) (*emptypb.Empty, error) {
	_, err := db.FromContext(ctx).Query("INSERT INTO tasks (task_id, text, callback_url) VALUES ($1, $2, $3)",
      req.ID, req.Text, req.CallbackURL)
	return &emptypb.Empty{}, err
}
```


---

### –î—Ä—É–≥–∏–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

* [ru] https://habr.com/ru/company/oleg-bunin/blog/461935/
* [en] http://go-database-sql.org/index.html
* [en] https://golang.org/pkg/database/sql
* [en] https://jmoiron.github.io/sqlx